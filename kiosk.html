<!-- kiosk.html (repo root) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JGQ Kiosk Launcher</title>
  <style>
    html, body { height: 100%; margin: 0; background:#000; color:#fff; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { height:100%; display:grid; place-items:center; padding:24px; }
    .card { max-width:720px; width:100%; background:rgba(255,255,255,0.06); border-radius:16px; padding:18px 18px; }
    .muted { opacity:0.75; }
    code { background:rgba(0,0,0,0.35); padding:2px 6px; border-radius:8px; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div><strong id="t">Starting kiosk…</strong></div>
    <div class="muted" id="d">Loading manifest and redirecting.</div>
    <div class="muted" style="margin-top:10px;">
      Tip: open full screen on the Chromebook.
    </div>
  </div>
</div>

<script>
// If kiosk already configured, allow reloading kiosk.html WITH new params.
// Only bounce when there is no querystring at all.
if (!location.search && localStorage.getItem('jwg_kiosk_playlist')) {
  // Use same-folder path (works on GitHub project pages + local)
  const here = location.pathname.replace(/[^/]*$/, '');
  location.replace(here + 'kiosk.html');
}

(async () => {
  const qs = new URLSearchParams(location.search);

  // You can override these like: kiosk.html?speed=90&dwell=12000&toppause=900&bottompause=900
  const config = {
    manifest: qs.get('manifest') || 'kiosk-manifest.json',
    speed: n(qs.get('speed'), 50),          // px/sec
    dwell: n(qs.get('dwell'), 11000),       // ms for short pages
    toppause: n(qs.get('toppause'), 1000),   // ms
    bottompause: n(qs.get('bottompause'), 1000), // ms
    minscroll: n(qs.get('minscroll'), 80),  // px
    transition: n(qs.get('transition'), 8000),   // ms: fixed veil time for “Coming next…”
    cachebust: (qs.get('cachebust') ?? '1') !== '0'
  };

  function n(v, fb){
  if (v === null) return fb;          // param not provided
  const s = String(v).trim();
  if (s === '') return fb;            // param provided but empty
  const x = Number(s);
  return Number.isFinite(x) ? x : fb;
}

  const t = document.getElementById('t');
  const d = document.getElementById('d');

  try {
    t.textContent = 'Fetching manifest…';

    const u = config.manifest + (config.cachebust ? `?ts=${Date.now()}` : '');
    const r = await fetch(u, { cache: config.cachebust ? 'no-store' : 'default' });
    if (!r.ok) throw new Error(`Manifest fetch failed: ${r.status}`);
    const m = await r.json();

    const home = norm((m.home || 'index.html').toString());
    const pages = Array.isArray(m.pages) ? m.pages.map(x => norm(String(x))) : [];

    const playlist = dedupe([home, ...pages].filter(Boolean));
    if (!playlist.length) throw new Error('Manifest produced empty playlist');

    // Optional: map of href -> friendly title (generated by generate_site_indexes.php)
    const titlesIn = (m && typeof m.titles === 'object' && m.titles) ? m.titles : {};
    const titles = {};
    for (const [k, v] of Object.entries(titlesIn)) {
      const kk = norm(String(k));
      const vv = String(v ?? '').trim();
      if (kk && vv) titles[kk] = vv;
    }

    // Store everything for kiosk runtime on each page
    localStorage.setItem('jwg_kiosk_playlist', JSON.stringify(playlist));
    localStorage.setItem('jwg_kiosk_titles', JSON.stringify(titles));
    localStorage.setItem('jwg_kiosk_config', JSON.stringify(config));
    localStorage.setItem('jwg_kiosk_idx', '0');

    d.textContent = `Playlist: ${playlist.length} page(s). Redirecting to ${home}…`;

    // Go to home in kiosk mode
    location.href = withKiosk(home, config.cachebust);
  } catch (e) {
    t.textContent = 'Kiosk error';
    d.textContent = String(e?.message || e);
    console.error(e);
  }

  function norm(p){
    p = (p || '').trim();
    if (!p) return '';
    if (p === '/') return 'index.html';
    if (p.startsWith('./')) p = p.slice(2);
    if (p.startsWith('/')) p = p.slice(1);
    return p;
  }
  function dedupe(arr){
    const out = [];
    const seen = new Set();
    for (const x of arr) { if (!seen.has(x)) { seen.add(x); out.push(x); } }
    return out;
  }
  function withKiosk(url, cachebust){
    const sep = url.includes('?') ? '&' : '?';
    const cb = cachebust ? `&kiosk_ts=${Date.now()}` : '';
    return `${url}${sep}kiosk=1${cb}`;
  }
})();
</script>
</body>
</html>
